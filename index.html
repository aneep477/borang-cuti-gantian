<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C-HRIS PRO | Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');
        :root { --glass: rgba(255, 255, 255, 0.03); --border: rgba(255, 255, 255, 0.1); }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #020617; color: white; min-height: 100vh; }
        .glass-card { background: var(--glass); backdrop-filter: blur(12px); border: 1px solid var(--border); border-radius: 24px; position: relative; transition: all 0.3s ease; }
        .glass-card:hover { border-color: #38bdf8; transform: translateY(-5px); }
        .glow { position: absolute; inset: 0; background: radial-gradient(circle 200px at var(--x) var(--y), rgba(56,189,248,0.15), transparent); opacity: 0; transition: 0.3s; pointer-events: none; }
        .glass-card:hover .glow { opacity: 1; }
        .input-glass { background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: white; transition: 0.3s; }
        .input-glass:focus { border-color: #38bdf8; outline: none; box-shadow: 0 0 15px rgba(56,189,248,0.2); }
    </style>
</head>
<body class="p-6 md:p-12">
    <div class="max-w-7xl mx-auto">
        <header class="flex justify-between items-center mb-12 animate__animated animate__fadeIn">
            <div>
                <h1 class="text-3xl font-extrabold italic">C-HRIS <span class="text-blue-500">PRO</span></h1>
                <p class="text-slate-500 text-[10px] tracking-[0.2em] uppercase">Sistem Pengurusan Cuti Gantian</p>
            </div>
            <div class="glass-card px-4 py-2 text-xs font-bold text-blue-400">‚óè HANIFF FAIZAL</div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
            <div class="glass-card p-8 animate__animated animate__zoomIn">
                <div class="glow"></div>
                <p class="text-slate-400 text-xs font-bold uppercase">Baki Jam Semasa</p>
                <h2 id="baki-terkini" class="text-5xl font-black mt-2">0.00</h2>
            </div>
            <div class="glass-card p-8 animate__animated animate__zoomIn" style="animation-delay: 0.1s">
                <div class="glow"></div>
                <p class="text-red-400 text-xs font-bold uppercase">Akan Luput (30H)</p>
                <h2 id="jam-akan-luput" class="text-5xl font-black mt-2 text-red-400">0.00</h2>
            </div>
            <div class="glass-card p-8 animate__animated animate__zoomIn" style="animation-delay: 0.2s">
                <div class="glow"></div>
                <p class="text-slate-400 text-xs font-bold uppercase">Jam Digunakan</p>
                <h2 id="jam-digunakan" class="text-5xl font-black mt-2 opacity-40">0.00</h2>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-4 glass-card p-8 animate__animated animate__fadeInLeft">
                <div class="glow"></div>
                <h3 class="text-xl font-bold mb-6 italic">+ Rekod Baru</h3>
                <form id="ot-form" class="space-y-4">
                    <input type="date" id="tarikh" class="input-glass w-full p-4 rounded-xl text-sm" required>
                    <input type="text" id="tugasan" placeholder="Nama Tugasan" class="input-glass w-full p-4 rounded-xl text-sm" required>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="time" id="jamMula" class="input-glass p-4 rounded-xl text-sm" required>
                        <input type="time" id="jamTamat" class="input-glass p-4 rounded-xl text-sm" required>
                    </div>
                    <input type="text" id="jumlahJamDisplay" class="w-full bg-transparent border-none text-blue-400 font-bold" readonly value="0 Jam 0 Minit">
                    <button type="submit" id="btn-submit" class="w-full bg-blue-600 p-4 rounded-xl font-bold hover:bg-blue-500 transition-all">Simpan Rekod</button>
                </form>
            </div>

            <div class="lg:col-span-8 glass-card overflow-hidden animate__animated animate__fadeInRight">
                <div class="glow"></div>
                <table class="w-full text-left text-sm">
                    <thead class="bg-white/5 text-[10px] uppercase text-slate-500 font-bold">
                        <tr>
                            <th class="p-6">Tarikh</th>
                            <th class="p-6">Tugasan</th>
                            <th class="p-6">Jam</th>
                            <th class="p-6 text-right">Status</th>
                        </tr>
                    </thead>
                    <tbody id="ot-records-body" class="divide-y divide-white/5"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbybiGrzYRTQjwrfAy9QcE7baMWARJ4Ce7BC_Nq-WXwnMZM27NOKSwBa1zdL-uV9obDB/exec'; // GANTIKAN INI

        // Glow Effect Logic
        document.querySelectorAll('.glass-card').forEach(card => {
            card.addEventListener('mousemove', e => {
                const rect = card.getBoundingClientRect();
                card.style.setProperty('--x', `${e.clientX - rect.left}px`);
                card.style.setProperty('--y', `${e.clientY - rect.top}px`);
            });
        });

        // Fetch Data
        async function fetchAllData() {
            try {
                const res = await fetch(API_URL);
                const result = await res.json();
                if (result.status === "success") {
                    updateStats(result.data.ot_records);
                    updateTable(result.data.ot_records);
                }
            } catch (e) { console.error("Ralat fetch:", e); }
        }

        function updateStats(records) {
            let baki = 0, guna = 0, luput = 0;
            const today = new Date();
            const limit = new Date(); limit.setDate(today.getDate() + 30);

            records.forEach(r => {
                if (r.status === 'Tersedia') {
                    baki += r.jumlahJam;
                    const p = r.tarikhLuput.split('/');
                    const exp = new Date(p[2], p[1]-1, p[0]);
                    if (exp <= limit && exp >= today) luput += r.jumlahJam;
                } else { guna += r.jumlahJam; }
            });
            document.getElementById('baki-terkini').innerText = baki.toFixed(2);
            document.getElementById('jam-akan-luput').innerText = luput.toFixed(2);
            document.getElementById('jam-digunakan').innerText = guna.toFixed(2);
        }

        function updateTable(records) {
            const body = document.getElementById('ot-records-body');
            body.innerHTML = records.map(r => `
                <tr class="hover:bg-white/5">
                    <td class="p-6 text-slate-400">${r.tarikh}</td>
                    <td class="p-6 font-bold">${r.tugasan}</td>
                    <td class="p-6 font-mono">${r.jumlahJam.toFixed(2)}j</td>
                    <td class="p-6 text-right">
                        <span class="px-3 py-1 rounded-full text-[9px] font-black uppercase ${r.status==='Tersedia'?'bg-green-500/10 text-green-400':'bg-red-500/10 text-red-400'}">${r.status}</span>
                    </td>
                </tr>
            `).join('');
        }

        // Simpan Data
        document.getElementById('ot-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-submit');
            btn.innerText = "Menyimpan...";
            btn.disabled = true;

            const payload = {
                action: 'add_ot',
                tarikh: document.getElementById('tarikh').value,
                tugasan: document.getElementById('tugasan').value,
                jumlahJam: calculateDuration()
            };

            await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
            alert("Rekod disimpan!");
            location.reload();
        });

        function calculateDuration() {
            const s = document.getElementById('jamMula').value, e = document.getElementById('jamTamat').value;
            if (!s || !e) return 0;
            const start = new Date(`1970-01-01T${s}`), end = new Date(`1970-01-01T${e}`);
            const diff = (end < start ? end.getTime()+86400000 : end.getTime()) - start.getTime();
            const hours = diff / 3600000;
            document.getElementById('jumlahJamDisplay').value = hours.toFixed(2) + " Jam";
            return hours;
        }

        document.addEventListener('DOMContentLoaded', fetchAllData);
    </script>
</body>
</html>
